var win=window.dialogArguments||opener||parent||top;function inArray(d,c){var b=c.length;for(var a=0;a<b;a++){if(c[a]==d){return true}}return false}function kcsbSlug(a){strNu=a.replace(/^\-+/,"");strNu=strNu.replace(/^_+/,"");strNu=strNu.replace(/[^A-Za-z0-9\-_]/g,"");if(strNu.match(/^\-+/)||strNu.match(/^_+/)){strNu=kcsbSlug(strNu)}return strNu}function invertColor(a){inverted=new RGBColor(a);if(inverted.ok){a="rgb("+(255-inverted.r)+", "+(255-inverted.g)+", "+(255-inverted.b)+")"}return a}(function(a){win.kcsInsertFiles=function(){var e=win.kcSettings.upload.nu.length;if(e){var b=win.kcSettings.upload.id,c=b.children().last(),f=a();while(e){e--;var d=c.clone();a("input",d).each(function(){this.value=win.kcSettings.upload.nu[e][0];a(this).prop("checked",false)});a(".title",d).text(win.kcSettings.upload.nu[e][1]);d.find("img").attr("src",win.kcSettings.upload.nu[e][2]);f=f.add(d)}b.append(f);if(c.is(".hidden")){f.show();c.remove()}b.show().prev(".info").show()}};a.fn.kcGoto=function(b){defaults={offset:-20,speed:800};b=a.extend({},defaults,b);return this.each(function(){var c=a(this);c.fadeIn(function(){a("html, body").stop().animate({scrollTop:(c.offset().top+b.offset)},b.speed)})})};a.fn.kcsbUnique=function(){return this.each(function(){var c=a(this),b=c.val();c.data("olVal",b).blur(function(){var f=a(this),e=c.data("olVal"),d=f.val();if(d!=e&&inArray(d,kcSettings._ids[f.data("ids")])){f.val("")}})})};a.fn.kcsbCheck=function(){var b=a(this);if((b.attr("name")==="kcsb[id]"&&b.val()==="id")||b.val()===""){b.val("").focus().css("borderColor","#ff0000");return false}else{b.removeAttr("style")}};a.fn.kcFormDep=function(b){defaults={disable:true,callback:function(){}};b=a.extend({},defaults,b);return this.each(function(){var d=a(this),e=d.val(),f=(d.data("scope")!==undefined)?d.closest(d.data("scope")).find(d.data("child")):a(d.data("child")),c;if(!f.length){return}f.each(function(){var h=a(this),g=h.data("dep");if((typeof g==="string"&&g===e)||(typeof g==="object"&&inArray(e,g))){c=true}else{c=false}h.toggle(c);if(b.disable===true){h.find(":input").prop("disabled",!c)}})})};a.fn.kcReorder=function(h,d){var g=new RegExp(h+"\\]\\[(\\d+)"),f=new RegExp(h+"\\-(\\d+)"),c=a(this);if(d===true){var e=c.children(),b=0}else{var e=c,b=c.index()}e.each(function(){var i=a(this);i.find(":input").each(function(){this.name=this.name.replace(g,function(k,j){return h+"]["+b});if(this.id!==""){this.id=this.id.replace(f,function(k,j){return h+"-"+b})}});i.find("label").each(function(){var j=a(this),k=j.attr("for");if(k!==""&&k!==undefined){j.attr("for",k.replace(f,function(m,l){return h+"-"+b}))}});b++});return this}})(jQuery);jQuery(document).ready(function(e){var k=e("#kcsb"),f=e("form.kcsb"),c=e("#kc-settings-form");if(c.length){var d=c.find("div.metabox-holder");if(d.length){var b=d.attr("id"),i=c.find(":checkbox");if(i.length){var j=e();i.each(function(){var n=e("#"+b+"-"+this.value);if(!n.length){return}var m=e(this),l=e("#"+b+"-"+this.value+"-hide");m.data("sectHider",l).data("sectBox",n);if(!(this.checked===l[0].checked)){l.prop("checked",this.checked).triggerHandler("click")}j=j.add(m)});if(j.length){j.change(function(){var l=e(this);l.data("sectHider").prop("checked",this.checked).triggerHandler("click");if(this.checked){l.data("sectBox").kcGoto({offset:-40,speed:"slow"})}})}}}}e("ul.kc-rows").sortable({axis:"y",start:function(l,m){m.placeholder.height(m.item.outerHeight())},stop:function(l,m){m.item.parent().kcReorder(m.item.data("mode"),true).children().each(function(){e("> .actions .count",this).text(e(this).index()+1)})}});e(".row a.del").live("click",function(p){var o=e(this),l=o.closest(".row"),m=l.parent(),q=l.data("mode"),n=l.is(":last-child");if(!l.siblings(".row").length){return false}l.addClass("removing").fadeOut("slow",function(){l.remove();if(!n){m.kcReorder(q,true);if(f.length){m.children().each(function(){e("> .actions .count",this).text(e(this).index()+1)})}}});return false});e(".row a.add").live("click",function(q){var r=e(this),t=r.closest(".row"),m=t.parent(),p=t.data("mode"),n=t.is(":last-child"),o=t.clone(false).addClass("adding"),s=false,l=400;if(p=="sections"){s=true;l=1200}else{if(p=="fields"){s=true;l=800}}if(f.length){o.find(".kc-rows").each(function(){var u=e(this).children(".row");if(u.length>1){u.not(":first").remove()}});o.find(":input").each(function(){var u=e(this);if(this.type=="text"||this.type=="textarea"){u.removeAttr("style").val("")}else{if(this.type=="checkbox"||this.type=="radio"){u.prop("checked",this.checked)}}if(u.is(".kcsb-ids")){u.kcsbUnique()}})}else{o.find(":input").each(function(){e(this).val("")})}t.after(o);if(s){o.kcGoto({offset:-100,speed:l})}setTimeout(function(){o.removeClass("adding")},l);m.kcReorder(p,true);if(f.length){if(n){e("> .actions .count",o).text(o.index()+1)}else{m.children().each(function(){e("> .actions .count",this).text(e(this).index()+1)})}}return false});e(".row a.clear").live("click",function(l){e(this).closest(".row").find(":input").val("");return false});var a=e("input[type=date]");if(a.length&&Modernizr.inputtypes.date===false){var g=e("body").is(".admin-color-classic")?"cupertino":"flick";Modernizr.load([{load:win.kcSettings.paths.styles+"/jquery-ui/"+g+"/style.css",complete:function(){a.datepicker({dateFormat:"yy-mm-dd"})}}])}var h=e("input[type=color]");if(h.length&&Modernizr.inputtypes.color===false){Modernizr.load([{load:[win.kcSettings.paths.scripts+"/colorpicker/js/colorpicker.js",win.kcSettings.paths.scripts+"/colorpicker/css/colorpicker.css",win.kcSettings.paths.scripts+"/rgbcolor.js"],complete:function(){h.ColorPicker({onBeforeShow:function(){e(this).ColorPickerSetColor(this.value)},onSubmit:function(l,p,n,o){var m="#"+p;e(o).css({backgroundColor:m,color:invertColor(m)}).val(m).ColorPickerHide()}}).each(function(){var l=e(this);if(l.val()!==""){l.css({backgroundColor:this.value,color:invertColor(this.value)})}})}}])}e(".kcs-file a.rm").live("click",function(n){n.preventDefault();var m=e(this),l=m.closest(".row");l.addClass("removing").fadeOut("slow",function(){if(l.siblings().length){l.remove()}else{l.removeClass("removing").addClass("hidden").find(":input").val("").prop("checked",false);e("input.fileID",l).prop("disabled",true);l.parent().hide().prev(".info").hide()}})});e("a.kcsf-upload").live("click",function(o){o.preventDefault();var m=e(this),n=m.parent(),l=n.find(".row.hidden");win.kcSettings.upload.id=e("#"+n.attr("id")+" > ul");win.kcSettings.upload.files=[];if(l.length){e("input.fileID",l).prop("disabled",false)}else{e("input.include",n).each(function(){win.kcSettings.upload.files.push(this.value)})}tb_show("",m.attr("href"))});e("ul.kc-sortable").sortable({axis:"y",start:function(l,m){m.placeholder.height(m.item.outerHeight())}});e("a.kc-help-trigger").live("click",function(){if(win.kcHelpBox!==undefined){win.kcPopHelp()}else{e("#contextual-help-link").click();e("#screen-meta").kcGoto()}return false});if(k.length){if(!k.is(".hidden")){k.kcGoto()}e(".hasdep",k).live("change",function(){e(this).kcFormDep({disable:true})}).change();e("input.kcsb-slug").live("blur",function(){var m=e(this),l=m.val();m.val(kcsbSlug(l))});e("input.kcsb-ids").kcsbUnique();e("input.required, input.clone-id").live("blur",function(){e(this).kcsbCheck()});e("#new-kcsb").live("click",function(){k.kcGoto();return false});e("a.kcsb-cancel").live("click",function(){e("#kcsb").fadeOut(function(){e("body").kcGoto()});return false});e("a.clone-open").live("click",function(){e(this).parent().children().hide().filter("div.kcsb-clone").fadeIn();return false});e("a.clone-do").click(function(){var l=e(this),m=e(this).siblings("input");if(m.kcsbCheck()===false){return false}l.attr("href",l.attr("href")+"&new="+m.val())});e("input.clone-id").bind("keypress",function(n){var l=n.keyCode||n.which;if(l===13){var m=e(this);n.preventDefault();m.blur().siblings("a.clone-do").data("new",m.val()).trigger("click")}});e(".kcsb-tools a.close").live("click",function(){var m=e(this),l=m.parent();m.siblings("input").val("");l.fadeOut(function(){e(this).siblings().show()});return false});f.submit(function(m){var l=true;e(this).find("input.required").not(":disabled").each(function(){if(e(this).kcsbCheck()===false){l=false;return false}});if(!l){return false}})}});